name: Docker
on: [ push]
env:
  DOCKER_CLI_EXPERIMENTAL: enabled
jobs:
  build_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: pre setup cleanup
        run: |
          sudo apt-get remove docker docker-engine docker.io containerd runc
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository "deb https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
          sudo apt update
          sudo apt -y install qemu-user qemu-user-binfmt
          sudo apt install -y docker-ce
          sudo docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
      - name: dockerhub login
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | \
          docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
      - name: create docker builder
        run: |
          docker buildx create --use --driver docker-container --name multibuilder
          docker buildx inspect --bootstrap
          docker version
          docker buildx ls
          docker buildx inspect multibuilder
      - name: Checkout
        uses: actions/checkout@v2
      - name: docker build and push
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm/v7,linux/arm64 \
            -t ${{ secrets.DOCKER_IMAGE }}:latest --push \
            .
